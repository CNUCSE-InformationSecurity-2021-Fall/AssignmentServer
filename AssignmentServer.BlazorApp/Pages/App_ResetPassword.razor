@inject ProtectedSessionStorage sessionStorage

@if (Completed is null)
{
    <div class="alert alert-info">
        비밀번호 변경 여부에 따라 자동으로 채점되는 과제입니다. 잠시만 기다려주세요...
    </div>
}
else if (Completed == false)
{
    <div class="alert alert-danger">
        비밀번호 변경이 확인되지 않았습니다!!
    </div>
}
else
{
    <div class="alert alert-success">
        비밀번호 변경이 확인되었습니다. 과제가 제출되었습니다!
    </div>
}

@code {
    [Parameter]
    public string AssignmentId { get; set; }

    public StudentInfo CurrentStudent;
    public bool? Completed;

    private void SubmitAssignment()
    {
        var cabinetPath = $"Cabinet/Students/{CurrentStudent.Id}/Assignments/{AssignmentId}.json";

        if (File.Exists(cabinetPath))
            return;

        var submitData = JsonConvert.SerializeObject(new {
            AssignmentId, Timestamp = new DateTime[] { DateTime.Now }, Score = 10
        });

        File.WriteAllText(cabinetPath, submitData, Encoding.UTF8);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var action = new StudentContextAction(sessionStorage);
            var student = await action.Check();

            CurrentStudent = student;
            Completed = student.PasswordChanged;

            if (Completed == true)
                SubmitAssignment();

            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }
}
